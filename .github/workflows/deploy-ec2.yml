name: Deploy (EC2)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-ec2
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH (git pull + docker compose up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -euo pipefail

            APP_DIR="${{ secrets.EC2_APP_DIR }}"
            BRANCH="${{ secrets.EC2_BRANCH || 'main' }}"
            REPO_URL="${{ secrets.EC2_REPO_URL }}"

            if [ -z "$APP_DIR" ]; then
              echo "EC2_APP_DIR secret is required" >&2
              exit 1
            fi

            mkdir -p "$APP_DIR"

            if [ ! -d "$APP_DIR/.git" ]; then
              if [ -z "$REPO_URL" ]; then
                echo "Repo not cloned yet, and EC2_REPO_URL is missing." >&2
                echo "Set EC2_REPO_URL to your public https clone URL (e.g. https://github.com/owner/repo.git)." >&2
                exit 1
              fi

              echo "Cloning repo into $APP_DIR..."
              git clone --branch "$BRANCH" "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "Fetching latest code..."
            git fetch --all --prune
            git checkout "$BRANCH"
            git reset --hard "origin/$BRANCH"

            echo "Building and starting containers..."
            docker compose down --remove-orphans
            docker compose up -d --build

            echo "Pruning unused images (best-effort)..."
            docker image prune -f || true

            echo "Deployment complete."