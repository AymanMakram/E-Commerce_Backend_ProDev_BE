{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5" style="direction: rtl;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0"><i class="fa-solid fa-cart-shopping me-2 text-info"></i> سلة التسوق</h2>
        <a href="/products/" class="btn btn-outline-info rounded-pill px-4">إضافة المزيد</a>
    </div>

    <div class="row">
        <div class="col-lg-8" id="cart-items-container">
            <div class="text-center py-5" id="cart-loader">
                <div class="spinner-border text-info" role="status"></div>
                <p class="mt-2 text-muted">جاري تحميل عناصر السلة...</p>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm p-4 sticky-top" style="border-radius: 20px; background-color: #f8f9fa; top: 20px;">
                <h5 class="fw-bold mb-4">ملخص الطلب</h5>
                <div class="d-flex justify-content-between mb-3 text-secondary">
                    <span>إجمالي العناصر</span>
                    <span id="cart-subtotal">0.00 ج.م</span>
                </div>
                <hr class="opacity-10">
                <div class="d-flex justify-content-between mb-4">
                    <span class="fs-5 fw-bold">الإجمالي النهائي</span>
                    <span id="cart-total" class="fs-4 fw-bold text-info">0.00 ج.م</span>
                </div>
                <button class="btn btn-info w-100 text-white fw-bold py-3 rounded-pill mb-3 shadow-sm">إتمام الشراء</button>
                <a href="/products/" class="btn btn-light w-100 text-muted fw-bold py-2 rounded-pill border">العودة للتسوق</a>
            </div>
        </div>
    </div>
</div>

<script>
    // صورة الطوارئ (SVG) تظهر فقط إذا فشل السيرفر تماماً في إرجاع أي مسار
    const DEFAULT_IMG = `data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22150%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22Arial%22%20font-size%3D%2218%22%20fill%3D%22white%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3EProduct%3C%2Ftext%3E%3C%2Fsvg%3E`;

    // Ensure correct API URL for cart
    window.CART_CONFIG.apiUrl = '/api/cart/';

    /**
     * جلب بيانات السلة من الـ API
     */
    async function fetchCartFromApi() {
        try {
            const response = await fetch(window.CART_CONFIG.apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            const loader = document.getElementById('cart-loader');
            if (loader) loader.remove();
            
            renderCartItems(data.items || []);
            updateSummary(data.total_price || 0);
            
            if (typeof updateGlobalCartCount === 'function') {
                updateGlobalCartCount(data);
            }
        } catch (error) {
            console.error("Fetch error:", error);
            document.getElementById('cart-items-container').innerHTML = 
                '<div class="alert alert-danger text-center">حدث خطأ أثناء تحميل السلة.</div>';
        }
    }

    /**
     * عرض العناصر في الصفحة
     */
    function renderCartItems(items) {
        const container = document.getElementById('cart-items-container');
        if (!items || items.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 bg-white shadow-sm rounded-4">
                    <i class="fa-solid fa-box-open fa-3x text-light mb-3"></i>
                    <p class="text-muted">سلة التسوق فارغة حالياً</p>
                </div>`;
            return;
        }

        container.innerHTML = items.map(item => {
            // استخراج البيانات مع قيم افتراضية للأمان
            const price = parseFloat(item.price || 0);
            const name = item.product_name || "منتج غير معروف";
            const qty = parseInt(item.quantity || item.qty || 1);
            const subtotal = (price * qty).toFixed(2);

            // الاعتماد على الرابط الكامل القادم من الـ Serializer المعدل
            // إذا لم يتوفر رابط، نستخدم صورة الطوارئ مباشرة
            let finalImageUrl = item.image ? item.image : DEFAULT_IMG;

            return `
                <div class="card mb-3 p-3 border-0 shadow-sm" style="border-radius: 15px;">
                    <div class="row align-items-center text-start">
                        <div class="col-md-2 text-center">
                            <img src="${finalImageUrl}" 
                                 class="img-fluid rounded" 
                                 style="max-height: 75px; width: 75px; object-fit: cover;" 
                                 onerror="this.onerror=null; this.src='${DEFAULT_IMG}';">
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="fw-bold mb-1 text-dark">${name}</h6>
                            <small class="text-muted">سعر القطعة: ${price.toLocaleString()} ج.م</small>
                        </div>

                        <div class="col-md-3">
                            <div class="d-flex align-items-center justify-content-center border rounded-pill bg-light p-1" style="max-width: 130px; margin: auto;">
                                <button class="btn btn-sm text-info fw-bold px-2" onclick="updateQuantity('${item.id}', ${qty - 1})">
                                    <i class="fa-solid fa-minus"></i>
                                </button>
                                <span class="mx-2 fw-bold text-dark">${qty}</span>
                                <button class="btn btn-sm text-info fw-bold px-2" onclick="updateQuantity('${item.id}', ${qty + 1})">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-3 text-end d-flex flex-column align-items-end">
                            <span class="text-info fw-bold fs-5">${parseFloat(subtotal).toLocaleString()} ج.م</span>
                            <button class="btn btn-link text-danger p-0 mt-2 text-decoration-none small" onclick="deleteCartItem('${item.id}')">
                                <i class="fa-solid fa-trash-can me-1"></i> حذف من السلة
                            </button>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    /**
     * تحديث ملخص السعر
     */
    function updateSummary(total) {
        const formattedTotal = parseFloat(total).toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById('cart-subtotal').textContent = formattedTotal + " ج.م";
        document.getElementById('cart-total').textContent = formattedTotal + " ج.م";
    }

    /**
     * تحديث الكمية عبر الـ API
     */
    async function updateQuantity(itemId, newQty) {
        if (newQty < 1) return;
        try {
            const response = await fetch(`${window.CART_CONFIG.itemsApiUrl}${itemId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.CART_CONFIG.csrfToken
                },
                body: JSON.stringify({ qty: newQty })
            });
            if (response.ok) fetchCartFromApi();
        } catch (e) { console.error("Update failed", e); }
    }

    /**
     * حذف عنصر من السلة
     */
    async function deleteCartItem(itemId) {
        if (!confirm("هل تريد حذف هذا المنتج من السلة؟")) return;
        try {
            const response = await fetch(`${window.CART_CONFIG.itemsApiUrl}${itemId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': window.CART_CONFIG.csrfToken }
            });
            if (response.ok) fetchCartFromApi();
        } catch (e) { console.error("Delete failed", e); }
    }

    // التشغيل عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', fetchCartFromApi);
</script>
{% endblock %}